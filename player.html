<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>StoryWays Player</title>
<style>
body { margin: 0; background:#0d0d0f; }
.hiddenPlayer {
    position: absolute;
    width: 200px !important;  /* YouTube 정책 통과를 위해 120x68 이상 필수 */
    height: 120px !important;
    left: -9999px;            /* 화면에서 안 보이게 */
    opacity: 0;
}
</style>
</head>
<body>

<tistory-player style="display:block;max-width:720px;margin:0 auto;padding:10px;">
<script type="application/json">
{
  "urls": [
    "https://youtu.be/oDhOws90Nlg?si=m0I5DEzPyalD4Apv",
    "https://youtu.be/DQAqY3767wA?si=r_EUcTkMRZAsmc8-",
    "https://youtu.be/q_4-m8Z2p7I?si=MqbbiluvU_PPIOrZ",
    "https://youtu.be/yHsXVpsSc3s?si=DpN1Iq9PN2L_eYHS",
    "https://youtu.be/iPo7y_8AocI?si=ENFGQzl5cp0NlTiQ",
    "https://youtu.be/4ejfFIj5rrA?si=7pYbXAh8dPQKbC7t",
    "https://youtu.be/Hl9Zbg6cRTA?si=0LZfqz4p1uecnw74",
    "https://youtu.be/jvO3GJe_D3M?si=ICWK6FL0TOFFk_68",
    "https://youtu.be/VaTtYIosT_o?si=Di0yJoSi1eppHSF1",
    "https://youtu.be/N5rKUi-ducc?si=buIOyIoJ8P3ex8e9",
    "https://youtu.be/t5qLyuQ5_J4?si=0uenh0uk5f-UzIFm",
    "https://youtu.be/gl7b91v9nsk?si=a1pOU38m-5P958C_"
  ],
  "randomStart": true
}
</script>
</tistory-player>

<div id="hiddenYt" class="hiddenPlayer"></div>

<script>
/* Utilities */
const fmt = s => { s=Math.max(0,s|0); const m=(s/60)|0, r=s%60; return m+":"+(r<10?"0"+r:r); };
const extractId = url=>{
  let m = String(url).match(/youtu\.be\/(\w{6,})/); if(m) return m[1];
  m = String(url).match(/[?&]v=(\w{6,})/); if(m) return m[1];
  return null;
};

/* Load YT API */
(function(){
  if (!window.YT) {
    const s=document.createElement("script");
    s.src="https://www.youtube.com/iframe_api";
    document.head.appendChild(s);
  }
})();

/* Custom Element */
class TistoryPlayer extends HTMLElement {
  constructor(){
    super();
    this.attachShadow({mode:'open'});
    this.shadowRoot.innerHTML = `
      <style>
      :host{color:#fff;font-family:sans-serif;display:block}
      .card{background:#111;padding:20px;border-radius:12px;border:1px solid #333}
      button{padding:8px 14px;margin:5px;font-size:14px;border-radius:6px;border:1px solid #555;background:#222;color:#fff;cursor:pointer}
      .title{font-weight:bold;margin:10px 0}
      </style>

      <div class="card">
        <div class="title" id="title">Loading...</div>
        <button id="prev">◀ Prev</button>
        <button id="play">▶ Play</button>
        <button id="next">Next ▶</button>
        <div style="margin-top:12px;font-size:12px;">
          <span id="cur">0:00</span> / <span id="dur">0:00</span>
        </div>
        <input id="seek" type="range" min="0" max="1000" value="0" style="width:100%;margin-top:8px;">
      </div>
    `;
  }

  connectedCallback(){
    const config = JSON.parse(this.querySelector("script").textContent);
    this.ids = config.urls.map(extractId).filter(Boolean);
    this.idx = config.randomStart ? Math.floor(Math.random()*this.ids.length) : 0;
    this.player = null;
    this.duration = 0;
    this.dragging = false;

    this.$title=this.shadowRoot.querySelector("#title");
    this.$cur=this.shadowRoot.querySelector("#cur");
    this.$dur=this.shadowRoot.querySelector("#dur");
    this.$seek=this.shadowRoot.querySelector("#seek");

    this.shadowRoot.querySelector("#play").onclick = ()=> this.togglePlay();
    this.shadowRoot.querySelector("#prev").onclick = ()=> this.load(this.idx-1);
    this.shadowRoot.querySelector("#next").onclick = ()=> this.load(this.idx+1);

    this.$seek.oninput = ()=>{ this.dragging=true; };
    this.$seek.onchange = ()=>{
      this.dragging=false;
      const t = (this.$seek.value/1000)*this.duration;
      this.player.seekTo(t,true);
    };

    window.onYouTubeIframeAPIReady = ()=> this.initPlayer();
    if (window.YT && window.YT.Player) this.initPlayer();

    this.tick = setInterval(()=>this.update(),200);
  }

  initPlayer(){
    this.player = new YT.Player("hiddenYt",{
      width:200,
      height:120,
      videoId: this.ids[this.idx],
      host:"https://www.youtube-nocookie.com",
      playerVars:{autoplay:0,controls:0,rel:0,playsinline:1},
      events:{
        onReady: ()=>{},
        onStateChange: e=>{
          if (e.data===1) this.shadowRoot.querySelector("#play").textContent="⏸ Pause";
          if (e.data===2) this.shadowRoot.querySelector("#play").textContent="▶ Play";
        }
      }
    });
  }

  load(i){
    this.idx=(i+this.ids.length)%this.ids.length;
    this.player.loadVideoById(this.ids[this.idx]);
  }

  togglePlay(){
    const st=this.player.getPlayerState();
    if(st===1) this.player.pauseVideo();
    else this.player.playVideo();
  }

  update(){
    if(!this.player || this.dragging) return;
    try{
      this.duration=Math.floor(this.player.getDuration());
      const cur=Math.floor(this.player.getCurrentTime());
      this.$cur.textContent=fmt(cur);
      this.$dur.textContent=fmt(this.duration);
      if(this.duration>0){
        this.$seek.value=Math.floor((cur/this.duration)*1000);
      }
      const data=this.player.getVideoData();
      if(data && data.title) this.$title.textContent=data.title;
    }catch(e){}
  }
}

customElements.define("tistory-player", TistoryPlayer);
</script>

</body>
</html>
